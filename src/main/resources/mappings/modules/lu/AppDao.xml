<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jeeplus.modules.app.dao.AppDao">
    
	<select id="selectAlarmrecord" parameterType="map" resultType="com.jeeplus.modules.lu.entity.AlarmsDefences">
		Select d.name as defencesName ,a.AlarmType as typeName,a.AlarmTime as date,a.State from alarms a LEFT JOIN defences d on  a.DefenceID = d.DID
		WHERE
		a.CustomerID=#{cid}
		<if test="startdate != null">
		AND
			a.AlarmTime <![CDATA[>]]> #{startdate}
		</if>
		<if test="enddate != null">
			AND a.AlarmTime <![CDATA[<]]> #{enddate}
		</if>
		<if test="alarmtype != null">
			AND a.AlarmType = #{alarmtype}
		</if>
		limit #{pageBegin},#{pageEnd}
	</select>

	<select id="getdefence" parameterType="string" resultType="com.jeeplus.modules.app.entity.DefencesDevice">
		SELECT a.DID as defenceid , a.Code as defencecode , a.Name as defencename, a.DefenceType as defencetype, b.devicetype as devicetype,
		b.masterid as masterid, b.state as state FROM defences a LEFT JOIN devices b on a.CustomerID = b.customerid
		WHERE a.CustomerID = #{cid}
	</select>

	<update id="updateDefence" parameterType="map" >
		UPDATE defences SET Name=#{defencename} , DefenceType=#{defencetype} WHERE DID=#{defenceid}
	</update>

	<select id="getDefences" parameterType="map" resultType="com.jeeplus.modules.app.entity.DefencesDevice">
		SELECT
			a.DID AS defenceid,
			a. CODE AS defencecode,
			a. NAME AS defencename,
			a.DefenceType AS defencetype,
			b.devicetype AS devicetype,
			a.masterid AS masterid,
			b.state AS state
		FROM
			defences a
		LEFT JOIN devices b ON a.DID = b.defenceid
		WHERE
			a.CustomerID = #{cid}
		AND a.DID IN (
			SELECT
				defenceid
			FROM
				devices
			WHERE
				customerid = #{cid}
		)
		<if test="masterid !=null and masterid != ''">
			AND b.masterid = #{masterid}
		</if>
		GROUP BY
			a.masterid,
			a.`Code`
		ORDER BY
			a.masterid ASC, a.`Code` ASC
	</select>
</mapper>
